---
title: "第一份工作总结"
updated: 2017-12-05 23:41:13
---

## 起    
2016年8月11日，刚从大连理工大学化院毕业的我为了一个月可以多挣点钱决定不再去学校报道。放弃成为一个高分子材料研究生，到上海打算做IT。    
到沪求职面了三家公司之后，我选择加入了**青岛科乐网络科技有限公司**。    
此篇回顾一下，在这家公司的一年时间，我都做了些什么。    
    
## CP维护    
公司业务是外汇平台，通过收取交易者手续费获得收益。    
带我的是在公司工作一年多脾气超级好长得好像小熊维尼萌萌哒小尹，彼时是后端的leader，负责管理卓德这个broker的后端。该项目简称CP。    
    
CP分两部分，一部分为给交易者使用的CRM，用来管理自己的交易账号，查看交易记录等；另一部分叫CPC，供马来西亚的CP工作人员管理会员树管理返佣使用。    
    
刚进去时接到的几个任务即是写脚本，修线上数据。有阵子几乎一天一个脚本，获得了*脚本小丸子*的称号。    
写脚本虽无聊，但对于项目的数据库设计以及业务的熟悉是有不小帮助的。    
    
回忆下做的几个比较大的功能：    
    
**1. 会员树的搜索展开**    
外汇业务中有IB收取下级trader返佣的场景。IB，包括BD，直到卓德作为最上层，形成了一个树状结构。而在CPC中，有着对这个树状结构的前端展示，一开始只有根结点，之后可以一层一层点开。最下层人员为trader，trader点开为其交易账号。    
    
对于CPC的使用者来说，每次都要从根开始往下点，会很烦，所以此需求是，输入一个用户名(或mt4账号)，会员树直接展开到这个节点的一层，包括路径节点。    
    
此需求很容易抽象成树的一个问题，解决起来还挺有意思，比较有挑战，实现出来用了两周左右，有一些递归以及分类的函数，在给前端的返回中，直接把一条路上的数据返回过去，不在搜索路径上的则不回传，以此来显示。    
由于存在双父级等特殊情况，还做了一些数据去重、修剪的操作，整个下来还是挺有难度的，比较有意思。    
    
**2. 报表**    
听闻，在我到这家公司之前，有个法国回来的硕士做报表，写了一个月，结果点击搜索后响应速度太慢，根本没法儿用，被Sheldon(老板之一)斥责还没有拿Excel算得快，之后被迫离开了公司。    
    
所以这个活儿落到了我头上时，是比较慌的。不过当时小尹及Sheldon给了解决方案，照着做做了一个月也最终完成了它，写在一个文件里面，大约1000行。之间为了补数据，加了好几个表莫名其妙的表，各种脚本补数据，定时脚本维护补的数据等等，烦得不行。    
    
包括最终的测试逻辑，复杂度很高，周期又比较长，比较煎熬。    
    
数据库使用的是MySQL，说起做报表，无非是一些查询SQL语句。难点在于会员树的层级搜索以及表结构设计的混乱。后来到七牛面试有一个类似的问题，可以用此方法解决。    
> 微博的某条回复，其他人可以回复这条回复，产生的第二层回复又可以被其他人再次回复，最终由此回复可以形成一个比较复杂的结构，如何直接查出由第一条回复为起始而产生的所有回复。    
    
该问题亦是当时做报表面临的最大的一个问题，解决方案为给回复加一个parent_path的列，记录其上的每条回复的uuid，在记录产生时加上，给此列加全文索引，用要查的回复的uuid去进行全文索引匹配，由于uuid的唯一性，则根据此列可直接找出所有的目标记录。    
    
编写中使用了大量的raw SQL，有拼接的写法，对于list与dict的转换比较烦人，后来发现了records库可以完美解决这个问题。    
    
**3. PAMM**    
业务需要自建一套PAMM系统，用于操盘手与trader之间关系的管理以及赚钱的分配代码。    
    
分两个方面，一个方面是PAMM的申请与审核规则，涉及到状态的转变以及跟前端沟通的经验，另一个则是分钱的触发机制 ，第一次用到了RabbitMQ做一个消息队列。    
其中还涉及到了Redis缓存，以及未命中重拉机制等，功能较大，亦做了一个月多。    
    
**4. 特殊IB**    
有钱就是爷，收了一个IB，他很厉害，他下面很多人，为他特殊做了一套规则，写了一万个if，还非要融于现有系统中，真的是恶心死人的需求。    
编写以及之后的测试过程，都很痛苦。    
    
以上为几个较大耗时较长的功能，其他不计其数的小需求不值一提。    
    
## 空间站    
邮件是公司业务中非常重要的一个环节，使用服务商为SendCloud。然而不够稳定，总是会有一些重要邮件收不到的情况。    
    
刚去时的解决方案为将邮件系统抽出，做了另一个项目，CP代码往一个库里插记录，另一个项目定时扫库，再通过SendCloud往外发，并跟踪状态。    
使用SendCloud总会出现发新浪邮箱很慢或者国外邮箱超时的状况，之前的同事还写了通过Gmail发送的线路。    
由于以MySQL做队列也是比较奇葩，而且监控重试策略不够完善，该邮件系统依然总是出问题，Sheldon需要一个比较彻底的解决方案。    
    
在之后的新项目中，要重写邮件服务，名字叫**空间站**。    
    
此次写主要使用RabbitMQ做一个异步发送队列，而且SendCloud，Gmail，MailGun等都做成不同的队列，通过服务商提供的回调接口来判断邮件是否送达，5分钟仍未收到回调的要转其他队列再次发送。    
    
在该项目的编写中学到了RabbitMQ的机制、功能及使用，以及一些参数的含义。之后将发送，与接收的部分抽离出来，做了common函数，供其他使用。    
此外，还首次使用MongoDB做邮件模板的存储、黑名单的维护以及邮件状态的跟踪。    
    
启一个Flask应用，开一个接口，往队列里塞消息，之后各个邮件服务商的队列启动之后，开始消费发邮件，改此条状态为已发送。在收到回调之后改为发送成功。同时跑定时脚本，监控超时未送达邮件任务去其他列队再次执行。    
    
代码设计上进行了一次大的重构，一开始写得很乱。后来写了一个发送邮件的基类，各个服务商继承此基类，做一些不同的细节处理，对于能用的改状态，try catch等代码是完全可以复用的。    
    
consumer的启动上使用**简单工厂模式**，启用时加入命令行参数找到要实例化的类，该映射用到了**表驱动法**。不在启动代码中写死启动哪个类，这样可以动态实例化某类，减少了很多可能存在的冗余代码。    
    
另外值得一提的是，common部分的代码，特别是配置，producer与consumer是两个进程，如何做到共用呢。复习了Python相关基础后，使用了更改sys.path的方法，将common模块加入到consumer得以解决。    
    
该项目还接入了短信通知及微信通知的服务，机制与上述相同，算是实现了一套比较可靠的异步消息推送的解决方案。    
    
## BOSS    
这是在科乐做的最重要付出心血最多的一个项目。    
BOSS的后端叫muxing。    
    
**需求**    
要做一个SaaS的外汇平台。公司不只满足于做卓德一家Broker项目，而是要做成Saas，将卓德看做其一个客户，同时还可支持其他客户，目的是拥有快速搭建一个Broker的能力，并且要做到：    
1. url、文案、页面布局、组件等展现可配；    
2. RBAC模型，权限控制要到表格的某一列；    
3. 登录注册审核出入金等流程可配；    
    
彼时小尹投入了交易系统后台的开发，而此项目的设计及开发任务完全落到了我的头上。这一个个的难题，需要一个个攻克，还是一个菜鸟的我，不得不成为了一个给出问题解决方案的人。    
    
**系统抽象**    
一个Broker是一个系统，有着自己的域名。    
一个Broker有多个页面，每个页面有多个组件，每个组件上有多个权限控制域，每个权限下又不着多个控件。    
以上为系统的一个统一的抽象。    
    
**展现可配**    
有一前置项目为配置中心，对上述可配的点进行选择，来初始化一个Broker。    
基本思想为将Broker的配置记下来存到库里，渲染页面时前端调接口，后端告诉前端其当初的选择，之后进行渲染。在某种程度上讲实为一种服务器端渲染。    
    
Broker建页面，为其设置url；为每个页面选择前端开发好的几套布局，在插槽位置插入某个组件(有组件库供选择)；在每个组件上选择其需要的权限控制域，不需要的不勾选，即在沉浸时不会看到其下控制的按钮或列。    
    
组件库是前端写的一段json，通过node在跳转页面时调接口，取得后端经权限以及文案渲染后(不同语言以及Broker对文案的修改)的组件细节，再渲染到浏览器页面。    
    
这种设计其实太过于精细了，没有什么必要，页面上的每一个字(比如登录二字)都可以更改，页面可以变成各种稀奇古怪的颜色。真的是有些overhead。    
    
**RBAC**    
RBAC有1，2，3版，一开始的需求要支持能切换(根本不考虑历史怎么做兼容吗？)。后被我说服只做一套最复杂的，让1，2版成为3的特殊情况，这样可以兼容，就不要扯什么一键切换这种异想天开的事情了。    
    
具体规则可以上网查资料，基本是角色到用户组再到用户。中间两个多对多的关系。    
选权限是为某个角色选，之后根据用户身上的角色集合来决定其权限集合。    
    
选权限的页面与系统抽象紧密相关，以组件为单位，选择其是否具有某组件上的某个权限，记到库里。权限起作用在两个地方：1. 给前端页面数据时，过滤掉一些控件，使用户看不到某个按钮或者某一列；2. 前端发请求时去库里验证该用户是否有触发该请求的按钮的权限。    
    
**工作流**    
这是最难的一个需求，而且花费时间最多。    
各Broker的情况都不一样，有的需要审核有的不要审核，有的要发邮件有的不发，要将这些做成配置而不能写在代码里，即对业务逻辑的抽离，有一个引擎运行这份配置，将流程走下去。不去硬编码任何业务逻辑。    
    
刚开始不知天高地厚要自己写，写了两到三版，每次做完当时的需求，Sheldon都会提出现在模型解决不了的新问题新场景。后来干脆放弃，引入关于工作流的BPMN2.0规范以及其Java实现Activiti。    
    
研究了一段时间Java，学习了Spring Boot框架以及maven。并且最终实现了Spring Boot与Activitia的集成。写了三篇很完备的笔记放到了博客上。    
出于开发效率的考虑，将操作DB的部分依旧放到Python代码，在Activiti流程图中可以加一些listener，在其中发http请求给muxing，后者处理DB后返回结果给Spring Boot，其继续流程。    
即，Java只处理流程图，处理BPMN2.0的语义，同时做为一个代理，将真实的服务，操作DB，对接外部系统API等委托给Python做处理，其只需发http请求即可。    
    
**服务划分**    
大致记得分为以下几块：    
1. 配置中心；    
2. 权限服务，两点，发请求时确认其是否有该权限，以及对返回数据的过滤；    
3. space factory，处理长时间脚本任务，众RabbitMQ中取；    
4. muxing，业务DB操作；    
5. muxing-engine，工作流引擎。    
以上环节，需要沟通的使用mule ESB连接起来，彼时不知微服务要用thrift，也是强行做下去。    
    
**系统演化**    
配置中心配置页面等，选择组件上要的权限等；    
一键生成该Broker的root用户，有所有权限，其可登录OSS，进行创建角色，编辑用户组等；    
用户可以开始注册。    
    
    
## 所得    
当初决定离开化学时，觉得开始做IT第一年，能入个行就不错了，与科班生相比，本身即是处于劣势。    
在回想起刚到公司参加工作时自己真的是菜的要死，基本是一无所知，在科乐工作的一年也算是学到了很多东西，包括技术上以及与人沟通层面的方面。    
    
与前端接接口的过程中，学到了接口文档的重要性；    
改测试同学报bug的过程中，学到了一些常见边界情况的考虑点与解决方法；    
维护CP项目，让我对烂代码嗤之以鼻，对copy paste现象恨之入骨，也学到了如何使用Redis做缓存，并且见过了各种缓存更新不及时造成bug的例子；    
在空间站的开发中，学习了RabbitMQ异步队列的使用；    
在工作中认识到了有效沟通是多么的重要，减少沟通成本，不同岗位人员之间通过工具实现解耦是提升整体效率及项目进度的很重要的一个命题。    
    
当然学到最多的，还是BOSS项目。    
做登录，将session维护在Redis的方案是我后来面试时给面试官的答案；    
做报表，要求高性能，设计索引，写复杂SQL，让我对关系型数据库特别是MySQL有了越来越深的了解；    
做工作流，使我学到了Java web的相关知识，以及maven的使用，并且为之后的工作打开了很广的思路，用BPMN2.0可以解决很多问题；    
工作流引擎从自写到放弃，才学到了工作中千万不要去重复造轮子；    
划分服务，让我学到了SOA，微服务，ESB等概念；    
    
最重要的，是在一个一个小的需求处理中，学到了解决问题，给方案的能力。而且使我在之后的面试中，有了一些谈资。    
    
## 公司存在的问题    
**CP代码烂**    
一个Python后端项目有14万行。    
层次不全，有handler层，却只是做转发，相当于废掉了；service层毫无抽象，每个接口开始都是新世界，重新开始探索；无model层。    
表设计上存在大量大字段，用mysql的列塞json，用dict取有4到5层，经常出现keyError。    
多个脚本维护一些项目的缺陷，脚本时常挂掉影响主流程。    
缓存写得很散，经常出现缓存未更新的情况。    
    
**在工具上折腾**    
先是用微信+石墨+Teambition，后搭建一套内网环境，不能上外网，开发用里面的CentOS，备受煎熬，往内网传东西要审批，影响工作效率及心情。    
迁至内网后使用禅道+Gogs+钉钉，文档位置混乱。    
最后买了一套Jira+Confluence，文档的维护与使用才算进入正轨。    
    
**项目不上线**    
有一个蘑菇路由器的项目，每当做好的时候，就再开始重构，如此往复有三到四遍，就是不上线，不开始卖。    
后做交易系统，前端同学也是做了三次，也不上线，要继续重构。    
BOSS每次完成这个目标，Sheldon都会提出下一个天马行空的点，一个登录注册做了四五次，每次都得重写。    
整个2017年折腾了一年，这些人做的项目全都没有上线。    
    
**承诺不兑现**    
面试时说试用期三个B+，涨2k，结果假装忘记此事，我去找，才只涨1k。    
说出去旅游，说了三个月，最后不了了之。    
5月说要给股份，到了8月结束也不给，一直拿各种事情拖，还不许问，问了还被批评私心太重。    
这是几个比较大的可以拿出来说的事情，其他的小事更是不计其数。    
说要招人，不招。    
    
**没有人带**    
公司自从闯爷和浩浩走了之后只剩下一群乌合之众，却被安排着做两个难度级高的项目。    
老板不愿意花钱请高水平人来带项目，而且不信任他们。    
磊磊和我是前后端对此感受最深的人，前后端的难点分别落在了他和我的身上。Sheldon一直在说，你可以的，你就是高手，说得天花乱坠，抛出一个个本不该由我解决的问题。说实话，真的是我水平不行，我拿着这点儿工资真的干不好应该拿我三倍工资的大佬干的活儿。    
事实证明，走的弯路很多，折腾(写了三版工作流引擎再废弃)很多。这样长期下去对我，对公司，都没有好处，可看明白这个问题的我和磊磊，改变不了什么。    
    
**幼儿园管理**    
公司没有leader，员工直接对老板。    
Dirk管理就是看态度，在单位时间越长，键盘敲得越响，他越满意，其他不管。新人来猛“照顾”新人，一句经典的话是：让你的键盘飞起来。这真是对程序员的侮辱。声称每晚6点开晚会，要坐办公室拖到7点，我提议打卡，又假心假意说不想给员工压力，无言以对。    
Sheldon什么都不想管，又什么都不信任，随便找出一个点，就开始乱怼。    
一个同事总结的好，他们信任你的时候，觉得你没有这个能力，觉得你有能力的时候，又开始不信任你。    
满嘴的要有奉献精神，我们是创业公司，问下拖了三个月的股权就被说有私心，画大饼，不可能做得出事。    
    
很多事情没有定规则，或则定规则后，还是老板说什么是什么。下班拖时间是一件，另一件事情是之前说有事情在群里吼出来，有天我跟Dirk反映了个问题，Sheldon生气得像要吃了我，说我不尊重老板，应该私下说。包括项目，什么都定不了，什么也做不了。    
    
## 离开科乐    
8月中旬的一天，跟磊磊出去溜达，得知了公司要全部迁到南京的消息。    
想起之前小尹他们早已搬了过去，看来公司是打算已久。    
要求两个周之内就搬过去，很是仓促，也的确是不太厚道。    
    
当时由于本身就在考虑要离开，加上给的薪酬不满意，便决定离职。    
我向来比较干脆，比较有意思的事情是，其他几个人都不说死，权衡利弊太久。    
乐平说看磊磊，磊磊说看我和涛涛，涛涛说看我，Dirk找我谈话时，我说，我就不过去了，我要留在上海。    
也是有些因吹斯挺。